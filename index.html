<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Change a layer's color with buttons</title>
<link rel="icon" href="./img/favicon.ico">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
.color-wrapper {
    display: flex;
    flex-direction: column;
}
.color-button {
    width: 100%;
    height: 30px;
    margin-bottom: 5px;
    border: none;
    cursor: pointer;
}
.color-button:focus {
    outline: none;
}
.clear-button {
    width: 100%;
    height: 30px;
    margin-bottom: 10px;
    border: none;
    cursor: pointer;
    background-color: #ffffff;
    color: #000000;
}
</style>
</head>
<body>
<style>
    .map-overlay {
        font:
            12px/20px 'Helvetica Neue',
            Arial,
            Helvetica,
            sans-serif;
        position: absolute;
        width: 200px;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay-inner fieldset {
        border: none;
        padding: 0;
        margin: 0 0 10px;
    }

    .map-overlay-inner fieldset:last-child {
        margin: 0;
    }

    .map-overlay-inner select {
        width: 100%;
    }

    .map-overlay-inner label {
        display: block;
        font-weight: bold;
        margin: 0 0 5px;
    }
</style>

<div id="map"></div>
<div class="map-overlay top">
    <div class="map-overlay-inner">

        <fieldset>
            <form id="fly">
                <div class="row m-2">
                    <!-- Select a city to fly to -->
                    <label>Fly to</label>
                    <select id="area" name="select" class="form-select">
                        <option value="">エリアを選択</option>
                        <option value="fly-okinawa">沖縄県</option>
                        <option value="fly-mainland">沖縄本島</option>
                        <option value="fly-miyako">宮古諸島</option>
                        <option value="fly-yaeyama">八重山諸島</option>
                    </select>
                </div>
            </form>
        </fieldset>

        <fieldset>
            <label>Select layer</label>
            <select id="layer" name="layer">
                <option value="">市町村を選択</option>
                <option value="naha">那覇市</option>
                <option value="ginowan">宜野湾市</option>
                <option value="ishigaki">石垣市</option>
                <option value="urazoe">浦添市</option>
                <option value="nago">名護市</option>
                <option value="itoman">糸満市</option>
                <option value="okinawa">沖縄市</option>
                <option value="tomigusuku">豊見城市</option>
                <option value="uruma">うるま市</option>
                <option value="miyakojima">宮古島市</option>
                <option value="nanjo">南城市</option>
                <option value="kunigamison">国頭村</option>
                <option value="ogimison">大宜味村</option>
                <option value="higashison">東村</option>
                <option value="nakijinson">今帰仁村</option>
                <option value="motobucho">本部町</option>
                <option value="onnason">恩納村</option>
                <option value="ginozason">宜野座村</option>
                <option value="kincho">金武町</option>
                <option value="ieson">伊江村</option>
                <option value="yomitanson">読谷村</option>
                <option value="kadenacho">嘉手納町</option>
                <option value="chatancho">北谷町</option>
                <option value="kitanakagusukuson">北中城村</option>
                <option value="nakagusukuson">中城村</option>
                <option value="nishiharacho">西原町</option>
                <option value="yonabarucho">与那原町</option>
                <option value="haebarucho">南風原町</option>
                <option value="kumejimacho">久米島町</option>
                <option value="tokashikison">渡嘉敷村</option>
                <option value="zamamison">座間味村</option>
                <option value="agunison">粟国村</option>
                <option value="tonakison">渡名喜村</option>
                <option value="minamidaitoson">南大東村</option>
                <option value="kitadaitoson">北大東村</option>
                <option value="iheyason">伊平屋村</option>
                <option value="izenason">伊是名村</option>
                <option value="yaesecho">八重瀬町</option>
                <option value="taramason">多良間村</option>
                <option value="taketomicho">竹富町</option>
                <option value="yonagunicho">与那国町</option>
            </select>
        </fieldset>
        <fieldset>
            <label>Choose a color</label>
            <div id="color-wrapper" class="color-wrapper"></div>
            <button id="clear-button" class="clear-button">All Clear</button>
        </fieldset>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibnlhbWF0byIsImEiOiJja2Y4dzNkOW8wY3MwMnFvM29iNnJzNzVzIn0.GHlHwu3r5YjKBU3qAKvccQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [127.93383619628926, 26.504074468870304],
        zoom: 9
    });

    map.on('load', () => {


        // Fly to functionality
        document.getElementById("fly").select.onchange = function() {
            var target = document.getElementById("fly").select.value;
            console.log(target);

            const flyLocations = {
                "fly-japan": { center: [136.33549197330444, 38.49148243962729], zoom: 4 },
                "fly-okinawa": { center: [125.48412170741628, 25.246402621655474], zoom: 7 },
                "fly-mainland": { center: [127.93383619628926, 26.504074468870304], zoom: 9 },
                "fly-miyako": { center: [125.27760692009161, 24.804254267582774], zoom: 10 },
                "fly-yaeyama": { center: [124.00066265308841, 24.38428842615502], zoom: 10 },
            };

            if (flyLocations[target]) {
                map.flyTo({
                    center: flyLocations[target].center,
                    zoom: flyLocations[target].zoom,
                    essential: true
                });
            }
        };

        function addLayer(id, geojsonPath) {
            map.addSource(id, {
                type: 'geojson',
                data: geojsonPath
            });
            map.addLayer({
                id: id,
                type: 'fill',
                source: id,
                paint: {
                    'fill-outline-color': 'rgba(0,0,0,1)',
                    'fill-color': getSavedColor(id) || 'rgba(255,255,255,1)' // Retrieve color from localStorage
                }
            });

            // ポップアップ //
            map.on('click', id, function (e) {
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(e.features[0].properties["N03_004"])
                    .addTo(map);
            });
            map.on('mouseenter', id, function () {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', id, function () {
                map.getCanvas().style.cursor = '';
            });

        }

        addLayer('agunison', './geojson/boundaries/agunison.geojson');
        addLayer('chatancho', './geojson/boundaries/chatancho.geojson');
        addLayer('ginowan', './geojson/boundaries/ginowan.geojson');
        addLayer('ginozason', './geojson/boundaries/ginozason.geojson');
        addLayer('haebarucho', './geojson/boundaries/haebarucho.geojson');
        addLayer('higashison', './geojson/boundaries/higashison.geojson');
        addLayer('ieson', './geojson/boundaries/ieson.geojson');
        addLayer('iheyason', './geojson/boundaries/iheyason.geojson');
        addLayer('ishigaki', './geojson/boundaries/ishigaki.geojson');
        addLayer('itoman', './geojson/boundaries/itoman.geojson');
        addLayer('izenason', './geojson/boundaries/izenason.geojson');
        addLayer('kadenacho', './geojson/boundaries/kadenacho.geojson');
        addLayer('kincho', './geojson/boundaries/kincho.geojson');
        addLayer('kitadaitoson', './geojson/boundaries/kitadaitoson.geojson');
        addLayer('kitanakagusukuson', './geojson/boundaries/kitanakagusukuson.geojson');
        addLayer('kumejimacho', './geojson/boundaries/kumejimacho.geojson');
        addLayer('kunigamison', './geojson/boundaries/kunigamison.geojson');
        addLayer('motobucho', './geojson/boundaries/motobucho.geojson');
        addLayer('minamidaitoson', './geojson/boundaries/minamidaitoson.geojson');
        addLayer('miyakojima', './geojson/boundaries/miyakojima.geojson');
        addLayer('nago', './geojson/boundaries/nago.geojson');
        addLayer('naha', './geojson/boundaries/naha.geojson');
        addLayer('nakagusukuson', './geojson/boundaries/nakagusukuson.geojson');
        addLayer('nakijinson', './geojson/boundaries/nakijinson.geojson');
        addLayer('nanjo', './geojson/boundaries/nanjo.geojson');
        addLayer('nishiharacho', './geojson/boundaries/nishiharacho.geojson');
        addLayer('ogimison', './geojson/boundaries/ogimison.geojson');
        addLayer('okinawa', './geojson/boundaries/okinawa.geojson');
        addLayer('onnason', './geojson/boundaries/onnason.geojson');
        addLayer('taketomicho', './geojson/boundaries/taketomicho.geojson');
        addLayer('taramason', './geojson/boundaries/taramason.geojson');
        addLayer('tokashikison', './geojson/boundaries/tokashikison.geojson');
        addLayer('tomigusuku', './geojson/boundaries/tomigusuku.geojson');
        addLayer('tonakison', './geojson/boundaries/tonakison.geojson');
        addLayer('urazoe', './geojson/boundaries/urazoe.geojson');
        addLayer('uruma', './geojson/boundaries/uruma.geojson');
        addLayer('yaesecho', './geojson/boundaries/yaesecho.geojson');
        addLayer('yomitanson', './geojson/boundaries/yomitanson.geojson');
        addLayer('yonabarucho', './geojson/boundaries/yonabarucho.geojson');
        addLayer('yonagunicho', './geojson/boundaries/yonagunicho.geojson');
        addLayer('zamamison', './geojson/boundaries/zamamison.geojson');

    });

    const colorWrapper = document.getElementById('color-wrapper');
    const layer = document.getElementById('layer');
    const colors = [
        { name: '無地', value: '#ffffff' },
        { name: '高付加価値ホテル', value: '#33a8c7' },
        { name: 'スポーツ', value: '#52e3e1' },
        { name: 'エンターテインメント', value: '#a0e426' },
        { name: 'グルメ', value: '#fdf148' },
        { name: '伝統文化', value: '#ffab00' },
        { name: '交通結節拠点', value: '#f77976' },
        { name: '教育・研究', value: '#f050ae' },
        { name: 'スタートアップ拠点', value: '#d883ff' },
        { name: '高付加価値マリンレジャー', value: '#9336fd' }
    ];

    for (const color of colors) {
        const button = document.createElement('button');
        button.textContent = color.name;
        button.className = 'color-button';
        button.style.backgroundColor = color.value;
        button.addEventListener('click', () => {
            map.setPaintProperty(layer.value, 'fill-color', color.value);
            saveColor(layer.value, color.value); // Save color to localStorage
        });
        colorWrapper.appendChild(button);
    }


    const clearButton = document.getElementById('clear-button');
    clearButton.addEventListener('click', () => {
        clearAllColors();
    });
    
    function clearAllColors() {
        const layers = document.getElementById('layer').options;
        for (let i = 1; i < layers.length; i++) {
            const layerId = layers[i].value;
            map.setPaintProperty(layerId, 'fill-color', '#ffffff'); // Set color to white for each layer
            saveColor(layerId, '#ffffff'); // Save color to localStorage
        }
    }

    function saveColor(layerId, color) {
        localStorage.setItem(layerId, color);
    }

    function getSavedColor(layerId) {
        return localStorage.getItem(layerId);
    }

</script>

</body>
</html>
